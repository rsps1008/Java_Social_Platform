<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts Page</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@3/dist/js.cookie.min.js"></script>

</head>
<body>
    <div id="app">
        <h1>Posts Page</h1>
        <div v-if="loggedIn">
            <button @click="logout">Logout</button>
			<table>
				<tbody>
					<tr v-for="post in posts" :key="post.id">
						<td>
						<div>
							<img :src="post.UserAvatar" style="width:50px; height:50px;">
							<div style="display: inline-block;">
								<strong>{{ post.UserID }}</strong><br>
								<small>{{ post.Created }}</small>
							</div>
						</div>
						<div>
							{{ post.Content }}
						</div>
						</td>
					</tr>
				</tbody>
			</table>
            <button @click="showAddPostForm = !showAddPostForm">Add New Post</button>
            <div v-if="showAddPostForm">
                <input type="text" v-model="newPost.content" placeholder="Content">
                <input type="text" v-model="newPost.imageUrl" placeholder="Image URL">
                <button @click="addNewPost">Submit</button>
            </div>
        </div>
        <div v-else>
            <p>Please login first.</p>
        </div>
    </div>

    <script>
		new Vue({
			el: '#app',
			data: {
				loggedIn: false,
				user: '',
				posts: [],
				newPost: {
					user: '',
					content: '',
					imageUrl: ''
				},
				showAddPostForm: false
			},
			created() {
				this.checkLoggedIn();
				this.getAllPosts();
			},
			methods: {
				checkLoggedIn() {
					// Check cookies for login status
					var loggedInCookie = Cookies.get('loggedIn');
					var userCookie = Cookies.get('user');

					if (loggedInCookie === '1') {
						this.loggedIn = true;
						this.user = userCookie;
					} else {
						this.loggedIn = false;
						// Optionally redirect to login page
						window.location.href = 'index.html';
					}
				},
				getAllPosts() {
					axios.get('/PostController/getAllPosts')
						.then(response => {
							this.posts = response.data;
						})
						.catch(error => {
							console.error('Error fetching posts:', error);
						});
				},		
				logout() {
					// Clear cookies on logout
					Cookies.remove('loggedIn');
					Cookies.remove('user');
					window.location.href = 'index.html';
				},
				addNewPost() {
					// 將新增貼文的使用者設置為當前登入用戶
					this.newPost.user = this.user;

					axios.post('/PostController/addNewPost', this.newPost)
						.then(response => {
							console.log('Post added successfully:', response.data);
							this.getAllPosts(); // Refresh posts after adding new post
							this.newPost = { user: '', content: '', imageUrl: '' }; // Clear input fields
						})
						.catch(error => {
							console.error('Error adding new post:', error);
						});
				}
			}
		});
	</script>
</body>
</html>